1. Проблемы тестирования базы данных (БД)

Тестирование кода, работающего с БД, осложняется тем, что сама БД является внешней инфраструктурой, а не частью кода приложения

 Основные риски: БД может быть недоступна, медленно работать или содержать «грязные» (старые) данные
 Ключевые проблемы при тестировании:
 1. Влияние тестов друг на друга: Данные, созданные одним тестом, могут повлиять на результаты другого
 2. Побочные эффекты: После выполнения тестов в БД могут оставаться тестовые данные
 3. Нестабильность: Из-за внешних факторов тесты могут «падать» без изменения кода

2. Правильная архитектура Repository (Предпосылка для тестирования)

Чтобы Repository было легко тестировать, он должен быть спроектирован особым образом

 Как нельзя делать (Плохо):
 1. Создавать подключение внутри init репозитория
 2. Это приводит к невозможности подменить БД на тестовую, контролировать транзакцию и изолировать тесты
 Как нужно делать (Хорошо):
 1. Внедрение зависимости (Dependency Injection): Репозиторий должен принимать объект подключения (connection) извне
 2. Это позволяет использовать тестовую БД и управлять транзакциями в тестах

3. Подходы к тестированию БД

Существует два основных подхода, у каждого из которых есть свои плюсы и минусы

Подход 1: Реальная тестовая БД

 Суть: Используется отдельная, настоящая БД (например, recipe_test)
 Плюсы: Проверяется реальный SQL-синтаксис, работа с Enum, ограничения (Foreign Key) и триггеры
 Минусы: Медленнее, чем unit-тесты
 Примечание: Repository лучше тестировать именно так

Подход 2: Mock (Имитация)

 Суть: С помощью библиотек для mock-объектов имитируется работа с БД
 Плюсы: Высокая скорость выполнения
 Минусы: Реальный SQL и ограничения БД не проверяются
 Примечание: Сервисы (Service) лучше тестировать с mock-репозиторием

4. Организация тестовой среды (Фикстуры pytest)

Для удобного и безопасного тестирования с реальной БД используются фикстуры pytest

 Тестовая БД: Создается отдельная БД (например, recipe_test), изолированная от продакшена Она может пересоздаваться для тестов
 Фикстура подключения (db_connection):
 1. Отвечает за подключение к тестовой БД
 2. Выполняется один раз для всех тестов в файле (scope="session")
 3. Создает схему БД (например, через init_schema)
 Фикстура транзакции (db или transaction):
 1. Запрашивает подключение (db_connection)
 2. Начинает транзакцию перед каждым тестом
 3. Предоставляет это подключение тесту
 4. Откатывает транзакцию (rollback) после завершения теста Это гарантирует полную изоляцию: данные каждого теста не видны другим и не засоряют БД

5. Примеры тестов для Repository

На примере репозитория рецептов (RecipeRepository) рассматриваются следующие тесты:

1. Тестирование get_by_id:
  1. Сценарий "успех": сохранить объект вручную, затем найти его по ID и проверить совпадение данных
  2. Сценарий "отсутствие записи": поиск по несуществующему ID должен вернуть None
2. Тестирование create:
  1. Вызвать метод создания
  2. Сделать прямой SELECT запрос к БД, чтобы убедиться, что запись действительно появилась
  3. Проверить, что вернулся объект с присвоенным ID

6. Негативные сценарии (Исключения)

Важно тестировать не только успешные сценарии, но и то, как код реагирует на ошибки БД

1. Нарушение Foreign Key (FK):
  1. Попытка создать рецепт с category_id, которого не существует в таблице категорий
  2. Ожидаемое поведение: исключение psycopg2.errors.ForeignKeyViolation
2. Нарушение ограничений Enum:
  1. Попытка сохранить уровень сложности (level), значение которого отсутствует в enum (например, "unreal") 
